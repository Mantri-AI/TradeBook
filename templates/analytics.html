{% extends "base.html" %}

{% block title %}Analytics - Mantri Trade Book{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-chart-bar me-2"></i>Portfolio Analytics</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshAnalytics()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="generateReport()">
                <i class="fas fa-file-pdf me-1"></i>Generate Report
            </button>
        </div>
    </div>
</div>

<!-- Analytics Dashboard -->
<div class="row">
    <!-- Portfolio Performance -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Portfolio Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Risk Metrics -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Risk Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="risk-metric mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Portfolio Beta</span>
                        <strong id="portfolioBeta">1.25</strong>
                    </div>
                </div>
                <div class="risk-metric mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Sharpe Ratio</span>
                        <strong id="sharpeRatio">0.85</strong>
                    </div>
                </div>
                <div class="risk-metric mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Max Drawdown</span>
                        <strong id="maxDrawdown" class="text-danger">-8.5%</strong>
                    </div>
                </div>
                <div class="risk-metric mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Volatility (30d)</span>
                        <strong id="volatility">15.2%</strong>
                    </div>
                </div>
                <div class="risk-metric">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">VaR (95%)</span>
                        <strong id="valueAtRisk" class="text-warning">-$2,450</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Asset Allocation and Sector Analysis -->
<div class="row">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-pie-chart me-2"></i>Asset Allocation
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-industry me-2"></i>Sector Breakdown
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trading Analytics -->
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>Trading Analytics
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" onclick="switchTradingView('volume')">Volume</button>
                    <button class="btn btn-outline-secondary" onclick="switchTradingView('frequency')">Frequency</button>
                    <button class="btn btn-outline-secondary" onclick="switchTradingView('pnl')">P&L</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="tradingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy me-2"></i>Performance Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="metric-small text-center mb-3">
                        <div class="metric-value text-success" id="winRate">65.4%</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                    <div class="metric-small text-center mb-3">
                        <div class="metric-value" id="avgWin">$245</div>
                        <div class="metric-label">Avg Win</div>
                    </div>
                    <div class="metric-small text-center mb-3">
                        <div class="metric-value text-danger" id="avgLoss">-$150</div>
                        <div class="metric-label">Avg Loss</div>
                    </div>
                    <div class="metric-small text-center mb-3">
                        <div class="metric-value" id="profitFactor">1.63</div>
                        <div class="metric-label">Profit Factor</div>
                    </div>
                    <div class="metric-small text-center mb-3">
                        <div class="metric-value" id="totalTrades">156</div>
                        <div class="metric-label">Total Trades</div>
                    </div>
                    <div class="metric-small text-center">
                        <div class="metric-value" id="avgHoldTime">2.3 days</div>
                        <div class="metric-label">Avg Hold Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Options Analytics -->
<div class="row">
    <div class="col-lg-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-link me-2"></i>Options Analytics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <canvas id="optionsChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h6>Options Summary</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tr>
                                    <td>Total Options Positions</td>
                                    <td><strong id="totalOptionsPositions">12</strong></td>
                                </tr>
                                <tr>
                                    <td>Calls vs Puts</td>
                                    <td>
                                        <span class="badge bg-success" id="callsCount">8</span> /
                                        <span class="badge bg-danger" id="putsCount">4</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Expiring This Week</td>
                                    <td><strong id="expiringThisWeek" class="text-warning">3</strong></td>
                                </tr>
                                <tr>
                                    <td>ITM Positions</td>
                                    <td><strong id="itmPositions" class="text-success">7</strong></td>
                                </tr>
                                <tr>
                                    <td>OTM Positions</td>
                                    <td><strong id="otmPositions" class="text-warning">5</strong></td>
                                </tr>
                                <tr>
                                    <td>Total Greeks</td>
                                    <td>
                                        <div class="small">
                                            Delta: <strong id="totalDelta">+0.45</strong><br>
                                            Gamma: <strong id="totalGamma">0.12</strong><br>
                                            Theta: <strong id="totalTheta">-15.2</strong><br>
                                            Vega: <strong id="totalVega">+8.5</strong>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Position Analysis -->
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>Position Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="analysisType">
                            <option value="concentration">Concentration Risk</option>
                            <option value="correlation">Correlation Matrix</option>
                            <option value="returns">Returns Distribution</option>
                            <option value="momentum">Momentum Analysis</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="timeframe">
                            <option value="1m">1 Month</option>
                            <option value="3m">3 Months</option>
                            <option value="6m">6 Months</option>
                            <option value="1y">1 Year</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="updateAnalysis()">
                            <i class="fas fa-chart-area me-1"></i>Update Analysis
                        </button>
                    </div>
                </div>
                
                <div id="analysisContent">
                    <div class="chart-container">
                        <canvas id="analysisChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .risk-metric {
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .risk-metric:last-child {
        border-bottom: none;
    }
    
    .metric-small {
        text-align: center;
    }
    
    .metric-small .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .metric-small .metric-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let performanceChart, allocationChart, sectorChart, tradingChart, optionsChart, analysisChart;
    
    $(document).ready(function() {
        initializeAllCharts();
        loadAnalyticsData();
    });
    
    function initializeAllCharts() {
        // Performance Chart
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Portfolio Value',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Benchmark (SPY)',
                    data: [],
                    borderColor: '#95a5a6',
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });
        
        // Allocation Chart
        const allocationCtx = document.getElementById('allocationChart').getContext('2d');
        allocationChart = new Chart(allocationCtx, {
            type: 'doughnut',
            data: {
                labels: ['Stocks', 'Options', 'Cash'],
                datasets: [{
                    data: [70, 25, 5],
                    backgroundColor: ['#3498db', '#e74c3c', '#2ecc71']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Sector Chart
        const sectorCtx = document.getElementById('sectorChart').getContext('2d');
        sectorChart = new Chart(sectorCtx, {
            type: 'bar',
            data: {
                labels: ['Technology', 'Finance', 'Healthcare', 'Consumer', 'Energy'],
                datasets: [{
                    data: [35, 20, 15, 20, 10],
                    backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Trading Chart
        const tradingCtx = document.getElementById('tradingChart').getContext('2d');
        tradingChart = new Chart(tradingCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Trading Volume',
                    data: [],
                    backgroundColor: '#3498db'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        
        // Options Chart
        const optionsCtx = document.getElementById('optionsChart').getContext('2d');
        optionsChart = new Chart(optionsCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Call Options',
                    data: [],
                    backgroundColor: 'rgba(46, 204, 113, 0.6)',
                    borderColor: '#2ecc71'
                }, {
                    label: 'Put Options',
                    data: [],
                    backgroundColor: 'rgba(231, 76, 60, 0.6)',
                    borderColor: '#e74c3c'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Days to Expiration'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Strike Price'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y + 
                                       ' (' + context.parsed.x + ' days)';
                            }
                        }
                    }
                }
            }
        });
        
        // Analysis Chart
        const analysisCtx = document.getElementById('analysisChart').getContext('2d');
        analysisChart = new Chart(analysisCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: '#3498db'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    function loadAnalyticsData() {
        // Load portfolio performance data
        fetch('/api/analytics/performance')
            .then(response => response.json())
            .then(data => {
                updatePerformanceChart(data);
            })
            .catch(error => console.error('Error loading performance data:', error));
        
        // Load portfolio allocation data
        fetch('/api/analytics/allocation')
            .then(response => response.json())
            .then(data => {
                updateAllocationChart(data);
            })
            .catch(error => console.error('Error loading allocation data:', error));
        
        // Load trading analytics
        fetch('/api/analytics/trading')
            .then(response => response.json())
            .then(data => {
                updateTradingChart(data);
            })
            .catch(error => console.error('Error loading trading data:', error));
        
        // Load options analytics
        fetch('/api/analytics/options')
            .then(response => response.json())
            .then(data => {
                updateOptionsAnalytics(data);
            })
            .catch(error => console.error('Error loading options data:', error));
        
        // Load risk metrics
        fetch('/api/analytics/risk')
            .then(response => response.json())
            .then(data => {
                updateRiskMetrics(data);
            })
            .catch(error => console.error('Error loading risk data:', error));
    }
    
    function updatePerformanceChart(data) {
        if (data.dates && data.portfolio_values) {
            performanceChart.data.labels = data.dates;
            performanceChart.data.datasets[0].data = data.portfolio_values;
            if (data.benchmark_values) {
                performanceChart.data.datasets[1].data = data.benchmark_values;
            }
            performanceChart.update();
        }
    }
    
    function updateAllocationChart(data) {
        if (data.allocation) {
            allocationChart.data.labels = Object.keys(data.allocation);
            allocationChart.data.datasets[0].data = Object.values(data.allocation);
            allocationChart.update();
        }
    }
    
    function updateTradingChart(data) {
        if (data.trading_volume) {
            tradingChart.data.labels = Object.keys(data.trading_volume);
            tradingChart.data.datasets[0].data = Object.values(data.trading_volume);
            tradingChart.update();
        }
    }
    
    function updateOptionsAnalytics(data) {
        if (data.options_positions) {
            const calls = data.options_positions.filter(pos => pos.option_type === 'call');
            const puts = data.options_positions.filter(pos => pos.option_type === 'put');
            
            optionsChart.data.datasets[0].data = calls.map(pos => ({
                x: pos.days_to_expiry,
                y: pos.strike_price
            }));
            
            optionsChart.data.datasets[1].data = puts.map(pos => ({
                x: pos.days_to_expiry,
                y: pos.strike_price
            }));
            
            optionsChart.update();
        }
        
        // Update options summary
        if (data.summary) {
            $('#totalOptionsPositions').text(data.summary.total_positions || 0);
            $('#callsCount').text(data.summary.calls_count || 0);
            $('#putsCount').text(data.summary.puts_count || 0);
            $('#expiringThisWeek').text(data.summary.expiring_this_week || 0);
            $('#itmPositions').text(data.summary.itm_positions || 0);
            $('#otmPositions').text(data.summary.otm_positions || 0);
            
            if (data.summary.greeks) {
                $('#totalDelta').text((data.summary.greeks.delta || 0).toFixed(2));
                $('#totalGamma').text((data.summary.greeks.gamma || 0).toFixed(2));
                $('#totalTheta').text((data.summary.greeks.theta || 0).toFixed(1));
                $('#totalVega').text((data.summary.greeks.vega || 0).toFixed(1));
            }
        }
    }
    
    function updateRiskMetrics(data) {
        if (data.metrics) {
            $('#portfolioBeta').text((data.metrics.beta || 0).toFixed(2));
            $('#sharpeRatio').text((data.metrics.sharpe_ratio || 0).toFixed(2));
            $('#maxDrawdown').text(formatPercent(data.metrics.max_drawdown || 0));
            $('#volatility').text(formatPercent(data.metrics.volatility || 0));
            $('#valueAtRisk').text(formatCurrency(data.metrics.var_95 || 0));
        }
        
        // Update performance stats
        if (data.performance_stats) {
            $('#winRate').text(formatPercent(data.performance_stats.win_rate || 0));
            $('#avgWin').text(formatCurrency(data.performance_stats.avg_win || 0));
            $('#avgLoss').text(formatCurrency(data.performance_stats.avg_loss || 0));
            $('#profitFactor').text((data.performance_stats.profit_factor || 0).toFixed(2));
            $('#totalTrades').text(data.performance_stats.total_trades || 0);
            $('#avgHoldTime').text((data.performance_stats.avg_hold_time || 0).toFixed(1) + ' days');
        }
    }
    
    function switchTradingView(viewType) {
        // Update button states
        $('.btn-group .btn').removeClass('active');
        $(`[onclick="switchTradingView('${viewType}')"]`).addClass('active');
        
        // Load new data based on view type
        fetch(`/api/analytics/trading?view=${viewType}`)
            .then(response => response.json())
            .then(data => {
                updateTradingChart(data);
            })
            .catch(error => console.error('Error loading trading view:', error));
    }
    
    function updateAnalysis() {
        const analysisType = $('#analysisType').val();
        const timeframe = $('#timeframe').val();
        
        showLoading();
        
        fetch(`/api/analytics/analysis?type=${analysisType}&timeframe=${timeframe}`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                updateAnalysisChart(data, analysisType);
            })
            .catch(error => {
                hideLoading();
                showError('Failed to load analysis data');
                console.error('Error:', error);
            });
    }
    
    function updateAnalysisChart(data, analysisType) {
        switch (analysisType) {
            case 'concentration':
                updateConcentrationChart(data);
                break;
            case 'correlation':
                updateCorrelationChart(data);
                break;
            case 'returns':
                updateReturnsChart(data);
                break;
            case 'momentum':
                updateMomentumChart(data);
                break;
        }
    }
    
    function updateConcentrationChart(data) {
        if (data.positions) {
            analysisChart.config.type = 'bar';
            analysisChart.data.labels = data.positions.map(p => p.symbol);
            analysisChart.data.datasets[0].data = data.positions.map(p => p.weight);
            analysisChart.data.datasets[0].label = 'Position Weight (%)';
            analysisChart.options.scales.y.ticks.callback = function(value) {
                return value + '%';
            };
            analysisChart.update();
        }
    }
    
    function updateCorrelationChart(data) {
        // Implementation for correlation matrix visualization
        showSuccess('Correlation analysis - Feature in development');
    }
    
    function updateReturnsChart(data) {
        if (data.returns_distribution) {
            analysisChart.config.type = 'histogram';
            // Update chart with returns distribution data
            analysisChart.update();
        }
    }
    
    function updateMomentumChart(data) {
        if (data.momentum_scores) {
            analysisChart.config.type = 'bar';
            analysisChart.data.labels = data.momentum_scores.map(m => m.symbol);
            analysisChart.data.datasets[0].data = data.momentum_scores.map(m => m.score);
            analysisChart.data.datasets[0].label = 'Momentum Score';
            analysisChart.update();
        }
    }
    
    function refreshAnalytics() {
        showLoading();
        loadAnalyticsData();
        setTimeout(() => {
            hideLoading();
            showSuccess('Analytics data refreshed');
        }, 1000);
    }
    
    function generateReport() {
        showLoading();
        
        fetch('/api/analytics/report', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Report generation failed');
            })
            .then(blob => {
                hideLoading();
                
                // Download the report
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `portfolio_report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                showSuccess('Report generated and downloaded successfully');
            })
            .catch(error => {
                hideLoading();
                showError('Failed to generate report');
                console.error('Error:', error);
            });
    }
</script>
{% endblock %}